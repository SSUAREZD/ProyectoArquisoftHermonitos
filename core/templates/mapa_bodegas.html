<!DOCTYPE html>
<html>
<head>
    <title>Mapa de Bodegas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <h1>Mapa de Bodegas</h1>
    <div id="map" style="height: 600px;"></div>

    <script>
         const bodegas = {{ bodegas_json|safe }};

    const map = L.map('map').setView([4.6, -74.1], 6); // Bogotá center

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
    }).addTo(map);

    function getColor(ocupacion) {
        if (ocupacion >= 90) return '#7a0b0b';      // muy saturado
        if (ocupacion >= 75) return '#d7301f';      // alto
        if (ocupacion >= 60) return '#fc8d59';      // medio-alto
        if (ocupacion >= 40) return '#fee08b';      // medio
        if (ocupacion >= 20) return '#d9ef8b';      // bajo-medio
        return '#91cf60';                           // bajo
    }

    for (const id in bodegas) {
        const bodega = bodegas[id];
        const { latitud, longitud, nombre, direccion, ocupacion_pct, capacidad, total_disponible, total_reservado } = bodega;
        if (!latitud || !longitud) continue;
        const occ = ocupacion_pct ?? 0;
        const marker = L.circleMarker([latitud, longitud], {
            radius: 10,
            color: getColor(occ),
            fillColor: getColor(occ),
            fillOpacity: 0.75
        }).addTo(map);
        marker.bindPopup(`
            <b>${nombre ?? 'Bodega'}</b><br>
            Dirección: ${direccion ?? '-'}<br>
            Capacidad: ${capacidad ?? 0}<br>
            Disponible: ${total_disponible ?? 0}<br>
            Reservado: ${total_reservado ?? 0}<br>
            Ocupación: ${occ}%
        `);
    }
    </script>
</body>
</html>