<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Dashboard de Bodegas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b0f1a; --card: #121826; --muted:#8fa0b8; --text:#e6eefc;
      --good:#17c964; --warn:#f5a524; --bad:#f31260;
    }
    * { box-sizing: border-box; } body { margin:0; background:#0b0f1a; color:var(--text); font-family:system-ui,Segoe UI,Roboto,Arial; }
    .container { max-width:1400px; margin:0 auto; padding:16px; }
    h1 { margin: 0 0 12px; }
    .kpis { display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin:12px 0; }
    .kpi { background:#121826; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px 12px; }
    .kpi .label { color:var(--muted); font-size:12px; }
    .kpi .value { font-size:22px; font-weight:700; }
    .grid { display:grid; gap:12px; grid-template-columns: 1.6fr 1fr; grid-auto-rows: 420px; }
    .card { background:#121826; border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:12px; overflow:hidden; }
    #map { width:100%; height:100%; min-height:420px; border-radius:10px; }
    .card h3 { margin:0 0 10px; font-size:16px; color:#cfe1ff; }
    .hidden { display:none; }
    @media (max-width:1100px) { .grid { grid-template-columns: 1fr; } .kpis { grid-template-columns: repeat(2,1fr); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard de Bodegas</h1>

    <!-- KPIs -->
    <div class="kpis" id="kpis">
      <div class="kpi"><div class="label">Bodegas</div><div class="value" id="kpi-warehouses">–</div></div>
      <div class="kpi"><div class="label">Ocupación Global</div><div class="value" id="kpi-occupancy">–</div></div>
      <div class="kpi"><div class="label">SKUs Totales</div><div class="value" id="kpi-skus">–</div></div>
      <div class="kpi"><div class="label">SKUs en Ruptura</div><div class="value" id="kpi-stockouts">–</div></div>
    </div>

    <div class="grid">
      <!-- Mapa ocupa 2 filas -->
      <div class="card" style="grid-row: span 2;">
        <h3>Mapa de Bodegas (ocupación)</h3>
        <div id="map"></div>
      </div>

      <div class="card">
        <h3>Mix Disponible vs Reservado (por bodega)</h3>
        <canvas id="mixChart"></canvas>
      </div>

      <div class="card">
        <h3>Aging de Inventario (días)</h3>
        <canvas id="agingChart"></canvas>
      </div>

      <div class="card">
        <h3>Top SKUs por Unidades</h3>
        <canvas id="topSkusChart"></canvas>
      </div>

      <div class="card">
        <h3>Tareas por Estado</h3>
        <canvas id="tasksChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // --- Utilidades ---
    const el = sel => document.querySelector(sel);
    const setText = (sel, txt) => { const n = el(sel); if (n) n.textContent = txt; };
    const tryFetch = async (url) => { try { const r = await fetch(url); if (!r.ok) throw new Error(r.status); return await r.json(); } catch { return null; } };
    const occupancyColor = (pct) => pct >= 85 ? '#f31260' : pct >= 60 ? '#f5a524' : '#17c964';

    (async function initMapAndKPIs() {
      const bodegas = await tryFetch('/api/bodegas/');
      // bodegas esperado: { "1": {nombre, direccion, latitud, longitud, promedio}, ... }
      const map = L.map('map').setView([4.6, -74.1], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

      if (bodegas) {
        let count = 0;
        for (const id in bodegas) {
          const b = bodegas[id];
          if (!b.latitud || !b.longitud) continue;
          count++;

          const pct = Math.round((b.promedio ?? 0));
          const marker = L.circleMarker([b.latitud, b.longitud], {
            radius: 10,
            color: occupancyColor(pct),
            fillColor: occupancyColor(pct),
            fillOpacity: 0.75
          }).addTo(map);

          marker.bindPopup(`
            <b>${b.nombre ?? 'Bodega'}</b><br>
            Dirección: ${b.direccion ?? '-'}<br>
            Ocupación aprox.: ${isFinite(pct) ? pct : 0}%
          `);
        }
        setText('#kpi-warehouses', count);
      }

      // KPIs
      const kpis = await tryFetch('/api/kpis/');
      if (kpis) {
        setText('#kpi-occupancy', (kpis.overall_occupancy_pct ?? 0) + '%');
        setText('#kpi-skus', kpis.sku_count ?? 0);
        setText('#kpi-stockouts', kpis.stockout_skus ?? 0);
      }
    })();

    // --- CHARTS helpers ---
    const makeChart = (id, cfg) => {
      const ctx = document.getElementById(id);
      if (!ctx) return null;
      try { return new Chart(ctx, cfg); } catch { return null; }
    };

    // Mix disponible vs reservado por bodega
    (async function(){
      const data = await tryFetch('/api/mix-disponible-reservado/');
      if (!data || !data.labels) { el('#mixChart')?.closest('.card')?.classList.add('hidden'); return; }
      makeChart('mixChart', {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [
            { label:'Disponible', data: data.disponible, stack:'mix' },
            { label:'Reservado', data: data.reservado, stack:'mix' }
          ]
        },
        options: {
          responsive:true,
          plugins:{ legend:{ labels:{ color:'#cfe1ff' } } },
          scales:{
            x:{ stacked:true, ticks:{ color:'#8fa0b8' }, grid:{ display:false } },
            y:{ stacked:true, ticks:{ color:'#8fa0b8' }, grid:{ color:'rgba(255,255,255,0.06)' } }
          }
        }
      });
    })();

    // Aging inventario
    (async function(){
      const data = await tryFetch('/api/aging/');
      if (!data || !data.labels) { el('#agingChart')?.closest('.card')?.classList.add('hidden'); return; }
      makeChart('agingChart', {
        type: 'bar',
        data: { labels: data.labels, datasets: [{ label:'Unidades', data: data.data }] },
        options: {
          plugins:{ legend:{ labels:{ color:'#cfe1ff' } } },
          scales:{
            x:{ ticks:{ color:'#8fa0b8' }, grid:{ display:false } },
            y:{ ticks:{ color:'#8fa0b8' }, grid:{ color:'rgba(255,255,255,0.06)' } }
          }
        }
      });
    })();

    // Top SKUs
    (async function(){
      const data = await tryFetch('/api/top-skus/');
      if (!data || !data.labels) { el('#topSkusChart')?.closest('.card')?.classList.add('hidden'); return; }
      makeChart('topSkusChart', {
        type: 'bar',
        data: { labels: data.labels, datasets: [{ label:'Unidades', data: data.data }] },
        options: {
          plugins:{ legend:{ labels:{ color:'#cfe1ff' } } },
          scales:{
            x:{ ticks:{ color:'#8fa0b8' }, grid:{ display:false } },
            y:{ ticks:{ color:'#8fa0b8' }, grid:{ color:'rgba(255,255,255,0.06)' } }
          }
        }
      });
    })();

    // Tareas por estado
    (async function(){
      const data = await tryFetch('/api/tareas-estado/');
      if (!data || !data.labels) { el('#tasksChart')?.closest('.card')?.classList.add('hidden'); return; }
      makeChart('tasksChart', {
        type: 'doughnut',
        data: { labels: data.labels, datasets: [{ data: data.data }] },
        options: { plugins:{ legend:{ labels:{ color:'#cfe1ff' } } } }
      });
    })();
  </script>
</body>
</html>
