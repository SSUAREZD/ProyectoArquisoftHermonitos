<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Dashboard de Bodegas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { --bg:#0b0f1a; --card:#121826; --muted:#8fa0b8; --text:#e6eefc; --good:#17c964; --warn:#f5a524; --bad:#f31260; }
    * { box-sizing:border-box; } body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Arial; }
    .container { max-width:1400px; margin:0 auto; padding:16px; }
    h1 { margin:0 0 12px; }
    .kpis { display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin:12px 0; }
    .kpi { background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px 12px; position:relative; }
    .kpi .label { color:var(--muted); font-size:12px; }
    .kpi .value { font-size:22px; font-weight:700; }
    .grid { display:grid; gap:12px; grid-template-columns:1.6fr 1fr; grid-auto-rows:420px; }
    .card { background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:12px; overflow:hidden; }
    #map { width:100%; height:100%; min-height:420px; border-radius:10px; }
    .card h3 { margin:0 0 10px; font-size:16px; color:#cfe1ff; }
    .hidden { display:none; }
    .pill { position:absolute; top:8px; right:8px; background:#243043; color:#9fb4d2; font-size:10px; padding:3px 8px; border-radius:20px; letter-spacing:.5px; }
    #clearFilterBtn { cursor:pointer; color:#53a6ff; font-size:12px; margin-left:8px; }
    #clearFilterBtn:hover { text-decoration:underline; }
    @media (max-width:1100px) { .grid { grid-template-columns:1fr; } .kpis { grid-template-columns:repeat(2,1fr); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard de Bodegas <span id="filterLabel" style="font-size:14px; font-weight:400; color:#8fa0b8;"></span><span id="clearFilterBtn" class="hidden">(Quitar filtro)</span></h1>

    <!-- KPIs -->
    <div class="kpis" id="kpis">
      <div class="kpi"><div class="label">Bodegas</div><div class="value" id="kpi-warehouses">–</div></div>
      <div class="kpi"><div class="label">Ocupación</div><div class="value" id="kpi-occupancy">–</div></div>
      <div class="kpi"><div class="label">SKUs</div><div class="value" id="kpi-skus">–</div></div>
      <div class="kpi"><div class="label">Stockouts</div><div class="value" id="kpi-stockouts">–</div></div>
      <div class="kpi"><div class="label">Vista</div><div class="value" id="kpi-scope">Global</div></div>
    </div>

    <div class="grid">
      <!-- Mapa -->
      <div class="card" style="grid-row:span 2;">
        <h3>Mapa de Bodegas (click para filtrar)</h3>
        <div id="map"></div>
      </div>

      <div class="card">
        <h3>Mix Disponible vs Reservado</h3>
        <canvas id="mixChart"></canvas>
      </div>

      <div class="card">
        <h3>Aging de Inventario</h3>
        <canvas id="agingChart"></canvas>
      </div>

      <div class="card">
        <h3>Top SKUs</h3>
        <canvas id="topSkusChart"></canvas>
      </div>

      <div class="card">
        <h3>Tareas por Estado</h3>
        <canvas id="tasksChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // Estado global de filtro
    let currentBodegaId = null;
    let charts = {}; // referencias a instancias Chart.js

    const el = sel => document.querySelector(sel);
    const setText = (sel, txt) => { const n = el(sel); if (n) n.textContent = txt; };
    const tryFetch = async (url) => { try { const r = await fetch(url); if (!r.ok) throw new Error(r.status); return await r.json(); } catch { return null; } };
    const occColor = (pct) => pct >= 85 ? '#f31260' : pct >= 50 ? '#f5a524' : '#17c964';

    function buildUrl(base){
      if (!currentBodegaId) return base;
      const sep = base.includes('?') ? '&' : '?';
      return base + sep + 'bodega_id=' + encodeURIComponent(currentBodegaId);
    }

    async function loadKPIs(){
      const data = await tryFetch(buildUrl('/api/kpis/'));
      if(!data) return;
      setText('#kpi-warehouses', data.total_warehouses ?? '0');
      setText('#kpi-occupancy', (data.overall_occupancy_pct ?? 0) + '%');
      setText('#kpi-skus', data.sku_count ?? '0');
      setText('#kpi-stockouts', data.stockout_skus ?? '0');
      if (data.filtered_bodega_id){
        setText('#kpi-scope', 'Bodega');
        el('#filterLabel').textContent = 'Filtrado: ' + (data.filtered_bodega_nombre || ('ID ' + data.filtered_bodega_id));
        el('#clearFilterBtn').classList.remove('hidden');
      } else {
        setText('#kpi-scope', 'Global');
        el('#filterLabel').textContent = '';
        el('#clearFilterBtn').classList.add('hidden');
      }
    }

    function destroyChart(id){ if(charts[id]) { charts[id].destroy(); delete charts[id]; } }

    function makeChart(id, cfg){
      destroyChart(id);
      const ctx = document.getElementById(id);
      if(!ctx) return;
      charts[id] = new Chart(ctx, cfg);
    }

    async function loadMix(){
      const d = await tryFetch(buildUrl('/api/mix-disponible-reservado/'));
      if(!d || !d.labels) return;
      makeChart('mixChart', {
        type:'bar',
        data:{ labels:d.labels, datasets:[
          { label:'Disponible', data:d.disponible, stack:'mix', background:'#17c964' },
          { label:'Reservado', data:d.reservado, stack:'mix', background:'#f5a524' }
        ]},
        options:{ responsive:true, plugins:{ legend:{ labels:{ color:'#cfe1ff' } } }, scales:{
          x:{ stacked:true, ticks:{ color:'#8fa0b8' }, grid:{ display:false } },
          y:{ stacked:true, ticks:{ color:'#8fa0b8' }, grid:{ color:'rgba(255,255,255,0.06)' } }
        }}
      });
    }
    async function loadAging(){
      const d = await tryFetch(buildUrl('/api/aging/'));
      if(!d) return;
      makeChart('agingChart', { type:'bar', data:{ labels:d.labels, datasets:[{ label:'Unidades', data:d.data, background:'#53a6ff' }] }, options:{ plugins:{ legend:{ labels:{ color:'#cfe1ff' } } }, scales:{ x:{ ticks:{ color:'#8fa0b8' }, grid:{ display:false } }, y:{ ticks:{ color:'#8fa0b8' }, grid:{ color:'rgba(255,255,255,0.06)' } } } } });
    }
    async function loadTop(){
      const d = await tryFetch(buildUrl('/api/top-skus/'));
      if(!d) return;
      makeChart('topSkusChart', { type:'bar', data:{ labels:d.labels, datasets:[{ label:'Unidades', data:d.data, background:'#8f6bff' }] }, options:{ plugins:{ legend:{ labels:{ color:'#cfe1ff' } } }, scales:{ x:{ ticks:{ color:'#8fa0b8' }, grid:{ display:false } }, y:{ ticks:{ color:'#8fa0b8' }, grid:{ color:'rgba(255,255,255,0.06)' } } } } });
    }
    async function loadTasks(){
      const d = await tryFetch(buildUrl('/api/tareas-estado/'));
      if(!d) return;
      makeChart('tasksChart', { type:'doughnut', data:{ labels:d.labels, datasets:[{ data:d.data, background:['#17c964','#f5a524','#53a6ff','#f31260','#8f6bff'] }] }, options:{ plugins:{ legend:{ labels:{ color:'#cfe1ff' } } } } });
    }

    async function reloadAll(){
      await loadKPIs();
      await Promise.all([loadMix(), loadAging(), loadTop(), loadTasks()]);
    }

    async function initMap(){
      const bodegas = await tryFetch('/api/bodegas/');
      const map = L.map('map').setView([4.6, -74.1], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:18 }).addTo(map);
      if(!bodegas) return;
      let count=0;
      for (const id in bodegas){
        const b = bodegas[id];
        if(!b.latitud || !b.longitud) continue; count++;
        const pct = Math.round((b.ocupacion_pct ?? 0));
        const marker = L.circleMarker([b.latitud, b.longitud], {
          radius:10, color:occColor(pct), fillColor:occColor(pct), fillOpacity:0.75
        }).addTo(map);
        marker.bindPopup(`<b>${b.nombre??'Bodega'}`);
        marker.on('click', async ()=>{
          currentBodegaId = id; await reloadAll();
        });
      }
      setText('#kpi-warehouses', count);
    }

    el('#clearFilterBtn').addEventListener('click', async ()=>{ currentBodegaId = null; await reloadAll(); });

    (async function start(){
      await initMap();
      await reloadAll();
    })();
  </script>
</body>
</html>
